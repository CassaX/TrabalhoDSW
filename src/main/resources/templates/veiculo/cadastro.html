<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head(#{app.title(#{vehicle.form_title})})}">
</head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="container my-5">
        <div th:replace="~{fragments/alert :: alert('success', ${success})}" th:if="${success}"></div>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 th:text="${veiculo.id} ? #{vehicle.edit_title} : #{vehicle.form_title}">
                Cadastrar Veículo
            </h2>
            <a th:href="@{/veiculos/meus-veiculos}" class="btn btn-outline-secondary" th:text="#{form.back}">Voltar</a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <form th:action="@{/veiculos/salvar}" th:object="${veiculo}" method="post" enctype="multipart/form-data">
                    <input type="hidden" th:field="*{id}">
                    <input type="hidden" th:field="*{loja.id}">
                    
                    <div class="row g-3">
                        <!-- Dados Básicos -->
                        <div class="col-md-6">
                            <label for="placa" class="form-label" th:text="#{vehicle.plate}">Placa</label>
                            <input type="text" class="form-control" id="placa" th:field="*{placa}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('placa')}" 
                                 th:errors="*{placa}"></div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="modelo" class="form-label" th:text="#{vehicle.model}">Modelo</label>
                            <input type="text" class="form-control" id="modelo" th:field="*{modelo}" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('modelo')}" 
                                 th:errors="*{modelo}"></div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="ano" class="form-label" th:text="#{vehicle.year}">Ano</label>
                            <input type="number" class="form-control" id="ano" th:field="*{ano}" min="1900" max="2023" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('ano')}" 
                                 th:errors="*{ano}"></div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="quilometragem" class="form-label" th:text="#{vehicle.mileage}">Quilometragem</label>
                            <input type="number" class="form-control" id="quilometragem" th:field="*{quilometragem}" min="0" required>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('quilometragem')}" 
                                 th:errors="*{quilometragem}"></div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="valor" class="form-label" th:text="#{vehicle.value}">Valor</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="valor" th:field="*{valor}" step="0.01" min="0" required>
                            </div>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('valor')}" 
                                 th:errors="*{valor}"></div>
                        </div>
                        
                        <div class="col-12">
                            <label for="descricao" class="form-label" th:text="#{vehicle.description}">Descrição</label>
                            <textarea class="form-control" id="descricao" th:field="*{descricao}" rows="3" required></textarea>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}" 
                                 th:errors="*{descricao}"></div>
                        </div>
                        
                        <!-- Upload de Fotos -->
                        <div class="col-12">
                            <label for="fotos" class="form-label" th:text="#{vehicle.photos}">Fotos (Máximo 10)</label>
                            <input type="file" class="form-control" id="fotos" name="fotos" multiple accept="image/*">
                            <div class="form-text" th:text="#{vehicle.photos_hint}">Selecione até 10 imagens do veículo</div>
                        </div>
                        
                        <!-- Pré-visualização das fotos existentes -->
                        <div class="col-12" th:if="${veiculo.fotos != null and !veiculo.fotos.empty}">
                            <h5 class="mt-3" th:text="#{vehicle.current_photos}">Fotos Atuais</h5>
                            <div class="vehicle-images">
                                <div th:each="foto, iterStat : ${veiculo.fotos}" class="image-thumbnail">
                                    <img th:src="@{'/uploads/' + ${foto}}" class="img-thumbnail" style="height: 120px;">
                                    <button type="button" class="btn btn-sm btn-danger remove-image" 
                                            th:attr="data-index=${iterStat.index}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary" th:text="#{form.save}">Salvar</button>
                        <a th:href="@{/veiculos/meus-veiculos}" class="btn btn-outline-secondary ms-2" th:text="#{form.cancel}">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/scripts :: scripts}"></div>
    
    <script>
    // Script para remoção de imagens
    document.querySelectorAll('.remove-image').forEach(button => {
        button.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            // Adiciona um campo hidden para marcar a foto para remoção
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'fotosRemovidas';
            input.value = index;
            this.closest('form').appendChild(input);
            // Remove a visualização da imagem
            this.closest('.image-thumbnail').remove();
        });
    });
    </script>
</body>
</html>